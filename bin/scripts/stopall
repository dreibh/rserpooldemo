#!/bin/sh
SLEEP=2


# Args:
#   $1 = Signal
#   $2 = Command to be killed
#   $3 = Optional "kill" parameters
kill_all() {
   echo "grep [0-9]:[0-9][0-9] $2"
   ps axwww|grep "[0-9]:[0-9][0-9] $2" | (
      while read pid tt stat time command ; do
         echo "KILL IT: pid=$pid cmd=$command"
         kill $1 $3 $pid
      done
   )
}


if [ x$1 = "xSIGKILL" ] ; then
   kill_all -SIGKILL "../../rsplib2/rsplib/fractalexample/fractalpooluser" -w
   kill_all -SIGKILL "../../rsplib2/rsplib/fractalpoolelement" -w
   kill_all -SIGKILL "../../rsplib2/rsplib/registrar" -w
   rm -rf ../../rsplib2/rsplib/*.pid
else
   ./scripts/demo-pu stop ../../rsplib2/rsplib 127.0.0.1:2960 2 -s SIGKILL
   ./scripts/demo-pu stop ../../rsplib2/rsplib 127.0.0.1:2960 1 -s SIGKILL
   ./scripts/demo-pe stop ../../rsplib2/rsplib 127.0.0.1:2960 256 20 -s SIGINT
   ./scripts/demo-pe stop ../../rsplib2/rsplib 127.0.0.1:2960 257 20 -s SIGINT
   ./scripts/demo-pe stop ../../rsplib2/rsplib 127.0.0.1:2960 258 20 -s SIGINT
   sleep $SLEEP
   ./scripts/demo-ns stop ../../rsplib2/rsplib 127.0.0.1:2960 65537 -s SIGINT
   ./scripts/demo-ns stop ../../rsplib2/rsplib 127.0.0.1:2960 65536 -s SIGINT
fi


echo Stop completed!
